<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habilita Fácil – Cadastro de Casamento</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F9FAFB; /* Very light, slightly warmer gray */
            color: #333333; /* Dark charcoal for main text */
        }
        .container {
            max-width: 900px;
            margin: 2.5rem auto; /* More margin top/bottom */
            padding: 3rem; /* Increased padding for more breathing room */
            background-color: #ffffff;
            border-radius: 20px; /* Even more rounded corners */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12); /* Deeper, softer shadow */
            border: 1px solid #F0F0F0; /* Subtle border */
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2.5rem; /* More space below header */
            color: #A0522D; /* Sienna for header icon/text */
        }
        .header h1 {
            font-size: 2.5rem; /* Larger title */
            font-weight: 700; /* Bolder title */
            color: #333333; /* Dark charcoal for title text */
        }
        .form-group label {
            font-weight: 500;
            color: #555555; /* Medium grey for labels */
            margin-bottom: 0.6rem;
            display: block;
            font-size: 0.95rem;
        }
        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group input[type="time"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.9rem; /* Increased padding */
            border: 1px solid #D8D8D8; /* Slightly darker light gray border */
            border-radius: 12px; /* More rounded input fields */
            font-size: 1rem;
            color: #333333;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            background-color: #FFFFFF; /* Ensure white background */
        }
        .form-group input[type="text"]:focus,
        .form-group input[type="date"]:focus,
        .form-group input[type="time"]:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #C27C4E; /* A slightly brighter, more inviting brown for focus */
            box-shadow: 0 0 0 4px rgba(194, 124, 78, 0.25); /* Matching shadow on focus */
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .checkbox-item input[type="checkbox"],
        .form-radio {
            margin-right: 0.75rem;
            width: 1.35rem; /* Slightly larger checkbox/radio */
            height: 1.35rem;
            border-radius: 6px; /* More rounded for checkboxes */
            border: 2px solid #9a9a9a; /* Thicker, darker gray border */
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
            position: relative;
            background-color: #EFEFEF;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .checkbox-item input[type="checkbox"]:checked,
        .form-radio:checked {
            background-color: #A0522D; /* Sienna when checked */
            border-color: #A0522D;
        }
        .checkbox-item input[type="checkbox"]:checked::after {
            content: '✔';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .form-radio {
            border-radius: 50%; /* Make radio buttons round */
        }
        .form-radio:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 0.6rem; /* Larger inner circle */
            height: 0.6rem;
            border-radius: 50%;
            background-color: white;
        }

        .section-title {
            font-size: 1.8rem; /* Larger section title */
            font-weight: 600;
            color: #333333;
            margin-bottom: 2rem; /* More margin */
            padding-bottom: 0.8rem; /* More padding */
            border-bottom: 2px solid #E0E0E0;
            display: flex;
            align-items: center;
            gap: 0.75rem; /* Space between icon and text */
        }
        .sub-section-title {
            font-size: 1.35rem; /* Slightly larger for sub-sections */
            font-weight: 600;
            color: #4A4A4A;
            margin-bottom: 1.2rem; /* More margin */
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }
        .card-section {
            padding: 1.75rem; /* More padding inside cards */
            background-color: #FDFDFD; /* Slightly off-white for card background */
            border-radius: 16px; /* Rounded corners for cards */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06); /* Subtle card shadow */
            border: 1px solid #F5F5F5; /* Very light border for cards */
            margin-bottom: 2.5rem; /* Space between cards */
        }
        .btn-primary {
            background-color: #A0522D; /* Sienna */
            color: white;
            padding: 1rem 2rem; /* Even larger padding for button */
            border-radius: 12px; /* More rounded button */
            font-weight: 600;
            letter-spacing: 0.03em; /* Slightly more letter spacing */
            transition: background-color 0.2s ease-in-out, transform 0.15s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 6px 15px rgba(160, 82, 45, 0.35); /* More prominent button shadow */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem; /* Space between button text and icon */
        }
        .btn-primary:hover {
            background-color: #8B4513; /* Darker Sienna on hover */
            transform: translateY(-3px); /* More pronounced lift on hover */
            box-shadow: 0 8px 20px rgba(139, 69, 19, 0.5); /* Deeper shadow on hover */
        }
        .grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .loading-text {
            text-align: center;
            padding: 2rem;
            font-style: italic;
            color: #888;
        }
        .pre-registration-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }
        .pre-registration-table th, .pre-registration-table td {
            border: 1px solid #E0E0E0;
            padding: 0.75rem;
            text-align: left;
        }
        .pre-registration-table th {
            background-color: #F0F0F0;
            font-weight: 600;
            color: #555;
        }
        .pre-registration-table tr:nth-child(even) {
            background-color: #FBFBFB;
        }
        .pre-registration-table tr:hover {
            background-color: #F0F0F0;
        }
        .action-buttons button {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
            border-radius: 8px;
            margin-right: 0.5rem;
            transition: background-color 0.2s ease;
        }
        .action-buttons .view-btn {
            background-color: #6B6B6B; /* Darker gray for view */
            color: white;
        }
        .action-buttons .view-btn:hover {
            background-color: #4A4A4A;
        }
        .action-buttons .delete-btn {
            background-color: #DC2626; /* Red for delete */
            color: white;
        }
        .action-buttons .delete-btn:hover {
            background-color: #B91C1C;
        }

        @media (max-width: 768px) {
            .container {
                margin: 1rem;
                padding: 1.5rem;
            }
            .grid-cols-2 {
                grid-template-columns: 1fr; /* Single column on small screens */
            }
            .header h1 {
                font-size: 2rem;
            }
            .section-title {
                font-size: 1.5rem;
            }
            .sub-section-title {
                font-size: 1.15rem;
            }
            .pre-registration-table, .pre-registration-table thead, .pre-registration-table tbody, .pre-registration-table th, .pre-registration-table td, .pre-registration-table tr {
                display: block;
            }
            .pre-registration-table thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            .pre-registration-table tr {
                border: 1px solid #E0E0E0;
                margin-bottom: 1rem;
                border-radius: 8px;
                overflow: hidden;
            }
            .pre-registration-table td {
                border: none;
                border-bottom: 1px solid #E0E0E0;
                position: relative;
                padding-left: 50%;
                text-align: right;
            }
            .pre-registration-table td:last-child {
                border-bottom: 0;
            }
            .pre-registration-table td:before {
                position: absolute;
                top: 0;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: 600;
                color: #555;
            }
            /* Data labels for mobile */
            .pre-registration-table td:nth-of-type(1):before { content: "Protocolo:"; }
            .pre-registration-table td:nth-of-type(2):before { content: "Noivo(a) 1:"; }
            .pre-registration-table td:nth-of-type(3):before { content: "Noivo(a) 2:"; }
            .pre-registration-table td:nth-of-type(4):before { content: "Data Casamento:"; }
            .pre-registration-table td:nth-of-type(5):before { content: "Tipo:"; }
            .pre-registration-table td:nth-of-type(6):before { content: "Ações:"; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <i data-lucide="heart" class="w-10 h-10 text-[#A0522D]"></i> <!-- Icon for header -->
            <h1>Habilita Fácil – Cadastro de Casamento</h1>
        </header>

        <!-- CHECKLIST INTERATIVO DE DOCUMENTOS -->
        <section class="card-section">
            <h2 class="section-title">
                <i data-lucide="clipboard-check" class="w-7 h-7 text-[#A0522D]"></i> <!-- Icon for section title -->
                1. Checklist Interativo de Documentos
            </h2>
            <div class="space-y-3">
                <div class="checkbox-item">
                    <input type="checkbox" id="doc1">
                    <label for="doc1" class="text-gray-700">Identidade e CPF originais de ambos os noivos(as)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="doc2">
                    <label for="doc2" class="text-gray-700">Certidão de nascimento ou casamento com averbação de divórcio</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="doc3">
                    <label for="doc3" class="text-gray-700">Comprovante de residência de ambos</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="doc4">
                    <label for="doc4" class="text-gray-700">Documentos das testemunhas (nome completo e CPF)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="doc5">
                    <label for="doc5" class="text-gray-700">Pacto antenupcial (se houver regime diverso do legal)</label>
                </div>
            </div>
        </section>

        <!-- FORMULÁRIO DE DADOS DO CASAL -->
        <section class="card-section">
            <h2 class="section-title">
                <i data-lucide="users" class="w-7 h-7 text-[#A0522D]"></i> <!-- Icon for section title -->
                2. Formulário de Dados do Casal
            </h2>
            <form id="marriageForm" class="space-y-8">

                <!-- Tipo de Casamento -->
                <div class="p-5 bg-gray-50 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="sub-section-title">
                        <i data-lucide="heart" class="w-5 h-5 text-[#A0522D]"></i>
                        Tipo de Casamento
                    </h3>
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="flex items-center">
                            <input type="radio" id="casamentoCivil" name="tipoCasamento" value="Civil" class="form-radio" checked>
                            <label for="casamentoCivil" class="ml-2 text-gray-700">Civil</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="casamentoReligioso" name="tipoCasamento" value="Religioso com Efeito Civil" class="form-radio">
                            <label for="casamentoReligioso" class="ml-2 text-gray-700">Religioso com Efeito Civil</label>
                        </div>
                    </div>
                </div>

                <!-- Campos Condicionais para Casamento Religioso -->
                <div id="camposReligioso" class="p-5 bg-gray-50 rounded-xl shadow-sm border border-gray-100" style="display: none;">
                    <h3 class="sub-section-title">
                        <i data-lucide="church" class="w-5 h-5 text-[#A0522D]"></i>
                        Detalhes da Celebração Religiosa
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="localCelebracao">Local de celebração:</label>
                            <input type="text" id="localCelebracao" name="localCelebracao">
                        </div>
                        <div class="form-group">
                            <label for="autoridadeReligiosa">Nome da autoridade religiosa:</label>
                            <input type="text" id="autoridadeReligiosa" name="autoridadeReligiosa">
                        </div>
                    </div>
                </div>

                <!-- Noivo(a) 1 -->
                <div class="p-5 bg-gray-50 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="sub-section-title">
                        <i data-lucide="user" class="w-5 h-5 text-[#A0522D]"></i>
                        Dados do(a) Noivo(a) 1
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="noivo1Nome">Nome completo:</label>
                            <input type="text" id="noivo1Nome" name="noivo1Nome" required>
                        </div>
                        <div class="form-group">
                            <label for="noivo1CPF">CPF:</label>
                            <input type="text" id="noivo1CPF" name="noivo1CPF" required>
                        </div>
                        <div class="form-group">
                            <label for="noivo1DataNascimento">Data de nascimento:</label>
                            <input type="date" id="noivo1DataNascimento" name="noivo1DataNascimento" required>
                        </div>
                        <div class="form-group">
                            <label for="noivo1Nacionalidade">Nacionalidade:</label>
                            <input type="text" id="noivo1Nacionalidade" name="noivo1Nacionalidade" required>
                        </div>
                        <div class="form-group">
                            <label for="noivo1Naturalidade">Naturalidade:</label>
                            <input type="text" id="noivo1Naturalidade" name="noivo1Naturalidade" required>
                        </div>
                        <div class="form-group">
                            <label for="noivo1EstadoCivil">Estado civil:</label>
                            <input type="text" id="noivo1EstadoCivil" name="noivo1EstadoCivil" required>
                        </div>
                        <div class="form-group">
                            <label for="noivo1Profissao">Profissão:</label>
                            <input type="text" id="noivo1Profissao" name="noivo1Profissao" required>
                        </div>
                        <div class="form-group">
                            <label for="noivo1NomeMae">Nome da mãe:</label>
                            <input type="text" id="noivo1NomeMae" name="noivo1NomeMae" required>
                        </div>
                        <div class="form-group">
                            <label for="noivo1NomePai">Nome do pai:</label>
                            <input type="text" id="noivo1NomePai" name="noivo1NomePai">
                        </div>
                        <div class="form-group md:col-span-2">
                            <label for="noivo1Endereco">Endereço completo:</label>
                            <input type="text" id="noivo1Endereco" name="noivo1Endereco" required>
                        </div>
                    </div>
                </div>

                <!-- Noivo(a) 2 -->
                <div class="p-5 bg-gray-50 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="sub-section-title">
                        <i data-lucide="user" class="w-5 h-5 text-[#A0522D]"></i>
                        Dados do(a) Noivo(a) 2
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="noivo2Nome">Nome completo:</label>
                            <input type="text" id="noivo2Nome" name="noivo2Nome" required>
                        </div>
                        <div class="form-group">
                            <label for="noivo2CPF">CPF:</label>
                            <input type="text" id="noivo2CPF" name="noivo2CPF" required>
                        </div>
                        <div class="form-group">
                            <label for="noivo2DataNascimento">Data de nascimento:</label>
                            <input type="date" id="noivo2DataNascimento" name="noivo2DataNascimento" required>
                        </div>
                        <div class="form-group">
                            <label for="noivo2Nacionalidade">Nacionalidade:</label>
                            <input type="text" id="noivo2Nacionalidade" name="noivo2Nacionalidade" required>
                        </div>
                        <div class="form-group">
                            <label for="noivo2Naturalidade">Naturalidade:</label>
                            <input type="text" id="noivo2Naturalidade" name="noivo2Naturalidade" required>
                        </div>
                        <div class="form-group">
                            <label for="noivo2EstadoCivil">Estado civil:</label>
                            <input type="text" id="noivo2EstadoCivil" name="noivo2EstadoCivil" required>
                        </div>
                        <div class="form-group">
                            <label for="noivo2Profissao">Profissão:</label>
                            <input type="text" id="noivo2Profissao" name="noivo2Profissao" required>
                        </div>
                        <div class="form-group">
                            <label for="noivo2NomeMae">Nome da mãe:</label>
                            <input type="text" id="noivo2NomeMae" name="noivo2NomeMae" required>
                        </div>
                        <div class="form-group">
                            <label for="noivo2NomePai">Nome do pai:</label>
                            <input type="text" id="noivo2NomePai" name="noivo2NomePai">
                        </div>
                        <div class="form-group md:col-span-2">
                            <label for="noivo2Endereco">Endereço completo:</label>
                            <input type="text" id="noivo2Endereco" name="noivo2Endereco" required>
                        </div>
                    </div>
                </div>

                <!-- Regime de Bens e Alteração de Nome -->
                <div class="p-5 bg-gray-50 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="sub-section-title">
                        <i data-lucide="wallet" class="w-5 h-5 text-[#A0522D]"></i>
                        Regime de Bens e Alteração de Nome
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="regimeBens">Regime de bens escolhido:</label>
                            <select id="regimeBens" name="regimeBens" required>
                                <option value="">Selecione</option>
                                <option value="Comunhão parcial">Comunhão parcial</option>
                                <option value="Comunhão universal">Comunhão universal</option>
                                <option value="Separação total">Separação total</option>
                                <option value="Participação final nos aquestos">Participação final nos aquestos</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="alteracaoNome">Haverá alteração de nome?</label>
                            <select id="alteracaoNome" name="alteracaoNome" required>
                                <option value="Não">Não</option>
                                <option value="Sim">Sim</option>
                            </select>
                        </div>
                        <div class="form-group md:col-span-2" id="campoNovoNome" style="display: none;">
                            <label for="novoNome">Novo nome (se houver alteração):</label>
                            <input type="text" id="novoNome" name="novoNome">
                        </div>
                    </div>
                </div>

                <!-- Data e Horário Pretendidos -->
                <div class="p-5 bg-gray-50 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="sub-section-title">
                        <i data-lucide="calendar" class="w-5 h-5 text-[#A0522D]"></i>
                        Data e Horário Pretendidos
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="dataCasamento">Data pretendida para o casamento:</label>
                            <input type="date" id="dataCasamento" name="dataCasamento" required>
                        </div>
                        <div class="form-group">
                            <label for="horarioCasamento">Horário pretendido:</label>
                            <input type="time" id="horarioCasamento" name="horarioCasamento" required>
                        </div>
                    </div>
                </div>

                <!-- Testemunhas -->
                <div class="p-5 bg-gray-50 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="sub-section-title">
                        <i data-lucide="users-round" class="w-5 h-5 text-[#A0522D]"></i>
                        Dados das Testemunhas
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="testemunha1Nome">Nome completo Testemunha 1:</label>
                            <input type="text" id="testemunha1Nome" name="testemunha1Nome" required>
                        </div>
                        <div class="form-group">
                            <label for="testemunha1CPF">CPF Testemunha 1:</label>
                            <input type="text" id="testemunha1CPF" name="testemunha1CPF" required>
                        </div>
                        <div class="form-group">
                            <label for="testemunha2Nome">Nome completo Testemunha 2:</label>
                            <input type="text" id="testemunha2Nome" name="testemunha2Nome" required>
                        </div>
                        <div class="form-group">
                            <label for="testemunha2CPF">CPF Testemunha 2:</label>
                            <input type="text" id="testemunha2CPF" name="testemunha2CPF" required>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-8">
                    <button type="submit" id="generatePdfBtn" class="btn-primary">
                        <i data-lucide="save" class="w-5 h-5"></i>
                        Salvar e Gerar PDF
                    </button>
                </div>
            </form>
        </section>

        <!-- Gerenciamento de Pré-Cadastros -->
        <section class="card-section">
            <h2 class="section-title">
                <i data-lucide="list-checks" class="w-7 h-7 text-[#A0522D]"></i>
                3. Pré-Cadastros Salvos
            </h2>
            <div class="form-group mb-4">
                <label for="searchPreRegistrations">Pesquisar por nome do(a) noivo(a) ou protocolo:</label>
                <input type="text" id="searchPreRegistrations" placeholder="Digite para pesquisar...">
            </div>
            <div id="preRegistrationsList" class="overflow-x-auto">
                <p class="loading-text" id="loadingPreRegistrations">Carregando pré-cadastros...</p>
                <table class="pre-registration-table hidden" id="preRegistrationsTable">
                    <thead>
                        <tr>
                            <th>Protocolo</th>
                            <th>Noivo(a) 1</th>
                            <th>Noivo(a) 2</th>
                            <th>Data Casamento</th>
                            <th>Tipo</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="preRegistrationsTableBody">
                        <!-- Pre-registrations will be loaded here -->
                    </tbody>
                </table>
                <p class="loading-text hidden" id="noPreRegistrations">Nenhum pré-cadastro encontrado.</p>
            </div>
        </section>
    </div>

    <!-- jsPDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Main application logic - Consolidated into a single module script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration (provided by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null; // To store the authenticated user ID
        let allPreRegistrations = []; // To store all fetched pre-registrations for filtering
        let domReady = false; // Flag to track DOM readiness

        // Function to format date from YYYY-MM-DD to DD/MM/YYYY
        function formatDate(dateString) {
            if (!dateString) return '';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }

        // Ensure jsPDF is available globally
        const jsPDF = window.jspdf.jsPDF; 

        // Authenticate user
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("Authenticated with UID:", userId);
                if (domReady) { // If DOM is ready, load data immediately
                    loadPreRegistrations();
                } else { // Otherwise, wait for DOM to be ready
                    document.addEventListener('DOMContentLoaded', loadPreRegistrations);
                }
            } else {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        userId = auth.currentUser.uid;
                        console.log("Signed in with custom token:", userId);
                        if (domReady) {
                            loadPreRegistrations();
                        } else {
                            document.addEventListener('DOMContentLoaded', loadPreRegistrations);
                        }
                    } catch (error) {
                        console.error("Error signing in with custom token:", error);
                        try {
                            await signInAnonymously(auth);
                            userId = auth.currentUser.uid;
                            console.log("Signed in anonymously:", userId);
                            if (domReady) {
                                loadPreRegistrations();
                            } else {
                                document.addEventListener('DOMContentLoaded', loadPreRegistrations);
                            }
                        } catch (anonError) {
                            console.error("Error signing in anonymously:", anonError);
                            const loadingElement = document.getElementById('loadingPreRegistrations');
                            if (loadingElement) {
                                loadingElement.textContent = "Erro ao autenticar. Por favor, recarregue a página.";
                            }
                        }
                    }
                } else {
                    try {
                        await signInAnonymously(auth);
                        userId = auth.currentUser.uid;
                        console.log("Signed in anonymously (no custom token):", userId);
                        if (domReady) {
                            loadPreRegistrations();
                        } else {
                            document.addEventListener('DOMContentLoaded', loadPreRegistrations);
                        }
                    } catch (anonError) {
                        console.error("Error signing in anonymously:", anonError);
                        const loadingElement = document.getElementById('loadingPreRegistrations');
                        if (loadingElement) {
                            loadingElement.textContent = "Erro ao autenticar. Por favor, recarregue a página.";
                        }
                    }
                }
            }
        });

        // Function to generate a unique protocol number
        function generateProtocolNumber() {
            const timestamp = Date.now();
            const random = Math.floor(Math.random() * 10000);
            return `PROTO-${timestamp}-${random}`;
        }

        // Function to load pre-registrations from Firestore
        function loadPreRegistrations() {
            if (!userId) {
                console.log("User not authenticated yet. Waiting to load pre-registrations.");
                return;
            }

            const preRegistrationsColRef = collection(db, `artifacts/${appId}/users/${userId}/marriageRegistrations`);
            const q = query(preRegistrationsColRef);

            onSnapshot(q, (snapshot) => {
                allPreRegistrations = [];
                snapshot.forEach((doc) => {
                    allPreRegistrations.push({ id: doc.id, ...doc.data() });
                });

                // Sort by dataCasamento (most recent first)
                allPreRegistrations.sort((a, b) => {
                    const dateA = new Date(a.dataCasamento);
                    const dateB = new Date(b.dataCasamento);
                    return dateB - dateA; // Descending order
                });

                displayPreRegistrations(allPreRegistrations);

                const loadingElement = document.getElementById('loadingPreRegistrations');
                const tableElement = document.getElementById('preRegistrationsTable');
                const noPreRegistrationsElement = document.getElementById('noPreRegistrations');

                if (loadingElement) loadingElement.classList.add('hidden');

                if (allPreRegistrations.length > 0) {
                    if (tableElement) tableElement.classList.remove('hidden');
                    if (noPreRegistrationsElement) noPreRegistrationsElement.classList.add('hidden');
                } else {
                    if (tableElement) tableElement.classList.add('hidden');
                    if (noPreRegistrationsElement) noPreRegistrationsElement.classList.remove('hidden');
                }
            }, (error) => {
                console.error("Error fetching pre-registrations:", error);
                const loadingElement = document.getElementById('loadingPreRegistrations');
                const tableElement = document.getElementById('preRegistrationsTable');
                const noPreRegistrationsElement = document.getElementById('noPreRegistrations');

                if (loadingElement) {
                    loadingElement.textContent = "Erro ao carregar pré-cadastros.";
                    loadingElement.classList.remove('hidden');
                }
                if (tableElement) tableElement.classList.add('hidden');
                if (noPreRegistrationsElement) noPreRegistrationsElement.classList.add('hidden');
            });
        }

        // Function to display pre-registrations in the table
        function displayPreRegistrations(registrations) {
            const tableBody = document.getElementById('preRegistrationsTableBody');
            if (!tableBody) {
                console.error("Table body element not found.");
                return;
            }
            tableBody.innerHTML = ''; // Clear existing rows

            const noPreRegistrationsElement = document.getElementById('noPreRegistrations');
            const preRegistrationsTableElement = document.getElementById('preRegistrationsTable');

            if (registrations.length === 0) {
                if (noPreRegistrationsElement) noPreRegistrationsElement.classList.remove('hidden');
                if (preRegistrationsTableElement) preRegistrationsTableElement.classList.add('hidden');
                return;
            } else {
                if (noPreRegistrationsElement) noPreRegistrationsElement.classList.add('hidden');
                if (preRegistrationsTableElement) preRegistrationsTableElement.classList.remove('hidden');
            }

            registrations.forEach(reg => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${reg.protocolNumber || 'N/A'}</td>
                    <td>${reg.noivo1Nome}</td>
                    <td>${reg.noivo2Nome}</td>
                    <td>${formatDate(reg.dataCasamento)}</td>
                    <td>${reg.tipoCasamento}</td>
                    <td class="action-buttons">
                        <button class="view-btn" data-id="${reg.id}">Visualizar PDF</button>
                        <button class="delete-btn" data-id="${reg.id}">Excluir</button>
                    </td>
                `;
            });

            // Re-create Lucide icons for newly added elements in the table
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
                console.log("Lucide icons re-initialized after table update.");
            } else {
                console.error("Lucide object not found when updating table.");
            }

            // Add event listeners for view and delete buttons
            tableBody.querySelectorAll('.view-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const id = event.target.dataset.id;
                    const registrationData = allPreRegistrations.find(reg => reg.id === id);
                    if (registrationData) {
                        generatePdf(registrationData); // Regenerate PDF from stored data
                    }
                });
            });

            tableBody.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', async (event) => {
                    const id = event.target.dataset.id;
                    showMessageBox('Confirmação', 'Tem certeza que deseja excluir este pré-cadastro?', true, async () => {
                        try {
                            await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/marriageRegistrations`, id));
                            showMessageBox('Sucesso', 'Pré-cadastro excluído com sucesso!');
                        } catch (error) {
                            console.error("Error deleting document:", error);
                            showMessageBox('Erro', 'Ocorreu um erro ao excluir o pré-cadastro.');
                        }
                    });
                });
            });
        }

        // Event listener for search input
        const searchInput = document.getElementById('searchPreRegistrations');
        if (searchInput) {
            searchInput.addEventListener('input', (event) => {
                const searchTerm = event.target.value.toLowerCase();
                const filteredRegistrations = allPreRegistrations.filter(reg =>
                    (reg.noivo1Nome && reg.noivo1Nome.toLowerCase().includes(searchTerm)) ||
                    (reg.noivo2Nome && reg.noivo2Nome.toLowerCase().includes(searchTerm)) ||
                    (reg.protocolNumber && reg.protocolNumber.toLowerCase().includes(searchTerm))
                );
                displayPreRegistrations(filteredRegistrations);
            });
        }

        // Modified showMessageBox to include a callback for confirmation
        function showMessageBox(title, message, isConfirm = false, onConfirm = null) {
            const messageBox = document.createElement('div');
            messageBox.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
            messageBox.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                    <p class="text-lg font-semibold ${title.includes('Atenção') || title.includes('Erro') ? 'text-red-600' : 'text-[#A0522D]'} mb-4">${title}</p>
                    <p class="text-gray-700 mb-6">${message}</p>
                    <div class="flex justify-center gap-4">
                        <button id="closeMessageBox" class="btn-primary">OK</button>
                        ${isConfirm ? '<button id="confirmMessageBox" class="btn-primary bg-red-600 hover:bg-red-700">Confirmar</button>' : ''}
                    </div>
                </div>
            `;
            document.body.appendChild(messageBox);

            document.getElementById('closeMessageBox').addEventListener('click', () => {
                document.body.removeChild(messageBox);
            });

            if (isConfirm && onConfirm) {
                document.getElementById('confirmMessageBox').addEventListener('click', () => {
                    document.body.removeChild(messageBox);
                    onConfirm();
                });
            }
        }


        // Centralized PDF Generation Function
        function generatePdf(dataToPrint) {
            const doc = new jsPDF();
            let y = 20;
            const pageHeight = doc.internal.pageSize.getHeight();
            const bottomMargin = 30;

            const addText = (text, x, fontSize = 10, fontStyle = 'normal') => {
                doc.setFont("helvetica", fontStyle);
                doc.setFontSize(fontSize);
                doc.text(text, x, y);
                y += fontSize / 2.5 + 5;
            };

            const addSectionTitle = (title) => {
                y += 10;
                doc.setFont("helvetica", "bold");
                doc.setFontSize(14);
                doc.text(title, 20, y);
                y += 8;
                doc.setDrawColor(200);
                doc.line(20, y, 190, y);
                y += 5;
            };

            const checkPageBreak = (requiredSpace = 40) => {
                if (y + requiredSpace >= pageHeight - bottomMargin) {
                    doc.addPage();
                    y = 20;
                }
            };

            // --- PDF Content Generation ---
            addSectionTitle('FICHA DE PRÉ-CADASTRO DE CASAMENTO');
            y = 40;

            addText(`Número de Protocolo: ${dataToPrint.protocolNumber || 'N/A'}`, 20, 12, 'bold');
            y += 10; // Extra space after protocol number

            checkPageBreak(30);
            addSectionTitle('TIPO DE CASAMENTO');
            addText(`Tipo de Casamento: ${dataToPrint.tipoCasamento}`, 20);
            if (dataToPrint.tipoCasamento === 'Religioso com Efeito Civil') {
                addText(`Local de Celebração: ${dataToPrint.localCelebracao || 'Não informado'}`, 20);
                addText(`Nome da Autoridade Religiosa: ${dataToPrint.autoridadeReligiosa || 'Não informado'}`, 20);
            }

            checkPageBreak(80);
            addSectionTitle('DADOS DO(A) NOIVO(A) 1');
            addText(`Nome completo: ${dataToPrint.noivo1Nome || 'Não informado'}`, 20);
            addText(`CPF: ${dataToPrint.noivo1CPF || 'Não informado'}`, 20);
            addText(`Data de nascimento: ${formatDate(dataToPrint.noivo1DataNascimento) || 'Não informado'}`, 20);
            addText(`Nacionalidade: ${dataToPrint.noivo1Nacionalidade || 'Não informado'}`, 20);
            addText(`Naturalidade: ${dataToPrint.noivo1Naturalidade || 'Não informado'}`, 20);
            addText(`Estado civil: ${dataToPrint.noivo1EstadoCivil || 'Não informado'}`, 20);
            addText(`Profissão: ${dataToPrint.noivo1Profissao || 'Não informado'}`, 20);
            addText(`Nome da mãe: ${dataToPrint.noivo1NomeMae || 'Não informado'}`, 20);
            addText(`Nome do pai: ${dataToPrint.noivo1NomePai || 'Não informado'}`, 20);
            addText(`Endereço completo: ${dataToPrint.noivo1Endereco || 'Não informado'}`, 20);

            checkPageBreak(80);
            addSectionTitle('DADOS DO(A) NOIVO(A) 2');
            addText(`Nome completo: ${dataToPrint.noivo2Nome || 'Não informado'}`, 20);
            addText(`CPF: ${dataToPrint.noivo2CPF || 'Não informado'}`, 20);
            addText(`Data de nascimento: ${formatDate(dataToPrint.noivo2DataNascimento) || 'Não informado'}`, 20);
            addText(`Nacionalidade: ${dataToPrint.noivo2Nacionalidade || 'Não informado'}`, 20);
            addText(`Naturalidade: ${dataToPrint.noivo2Naturalidade || 'Não informado'}`, 20);
            addText(`Estado civil: ${dataToPrint.noivo2EstadoCivil || 'Não informado'}`, 20);
            addText(`Profissão: ${dataToPrint.noivo2Profissao || 'Não informado'}`, 20);
            addText(`Nome da mãe: ${dataToPrint.noivo2NomeMae || 'Não informado'}`, 20);
            addText(`Nome do pai: ${dataToPrint.noivo2NomePai || 'Não informado'}`, 20);
            addText(`Endereço completo: ${dataToPrint.noivo2Endereco || 'Não informado'}`, 20);

            checkPageBreak(50);
            addSectionTitle('REGIME DE BENS E ALTERAÇÃO DE NOME');
            addText(`Regime de bens escolhido: ${dataToPrint.regimeBens || 'Não informado'}`, 20);
            addText(`Haverá alteração de nome? ${dataToPrint.alteracaoNome || 'Não informado'}`, 20);
            if (dataToPrint.alteracaoNome === 'Sim') {
                addText(`Novo nome: ${dataToPrint.novoNome || 'Não informado'}`, 20);
            }

            checkPageBreak(40);
            addSectionTitle('DATA E HORÁRIO PRETENDIDOS');
            addText(`Data pretendida para o casamento: ${formatDate(dataToPrint.dataCasamento) || 'Não informado'}`, 20);
            addText(`Horário pretendido: ${dataToPrint.horarioCasamento || 'Não informado'}`, 20);

            checkPageBreak(60);
            addSectionTitle('DADOS DAS TESTEMUNHAS');
            addText(`Testemunha 1: ${dataToPrint.testemunha1Nome || 'Não informado'} (CPF: ${dataToPrint.testemunha1CPF || 'Não informado'})`, 20);
            addText(`Testemunha 2: ${dataToPrint.testemunha2Nome || 'Não informado'} (CPF: ${dataToPrint.testemunha2CPF || 'Não informado'})`, 20);

            checkPageBreak(100);
            y += 20;
            addText('_______________________________________', 20, 10, 'normal');
            addText('NOIVO(A) 1', 20, 10, 'bold');
            y += 10;
            addText('_______________________________________', 110, 10, 'normal');
            addText('NOIVO(A) 2', 110, 10, 'bold');

            y += 20;
            addText('_______________________________________', 20, 10, 'normal');
            addText('TESTEMUNHA 1', 20, 10, 'bold');
            y += 10;
            addText('_______________________________________', 110, 10, 'normal');
            addText('TESTEMUNHA 2', 110, 10, 'bold');

            y += 20;
            addText('_______________________________________', 65, 10, 'normal');
            addText('ESCREVENTE', 65, 10, 'bold');

            doc.setFontSize(8);
            doc.setFont("helvetica", "italic");
            doc.text('Cartório de Registro Civil – Jacaraú/PB', doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() - 10, { align: 'center' });

            doc.save(`Pre-Cadastro-Casamento-${dataToPrint.protocolNumber}.pdf`);
        }

        // Initialize DOM-dependent elements and event listeners
        document.addEventListener('DOMContentLoaded', () => {
            domReady = true; // Set flag that DOM is ready

            // Initialize Lucide Icons for static elements
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
                console.log("Lucide icons initialized on DOMContentLoaded.");
            } else {
                console.error("Lucide object not found on DOMContentLoaded.");
            }

            const alteracaoNomeSelect = document.getElementById('alteracaoNome');
            const campoNovoNome = document.getElementById('campoNovoNome');
            const marriageForm = document.getElementById('marriageForm');
            // const generatePdfBtn = document.getElementById('generatePdfBtn'); // Not directly used here

            const casamentoCivilRadio = document.getElementById('casamentoCivil');
            const casamentoReligiosoRadio = document.getElementById('casamentoReligioso');
            const camposReligioso = document.getElementById('camposReligioso');
            const localCelebracaoInput = document.getElementById('localCelebracao');
            const autoridadeReligiosaInput = document.getElementById('autoridadeReligiosa');

            if (alteracaoNomeSelect) {
                alteracaoNomeSelect.addEventListener('change', () => {
                    if (alteracaoNomeSelect.value === 'Sim') {
                        if (campoNovoNome) campoNovoNome.style.display = 'block';
                    } else {
                        if (campoNovoNome) campoNovoNome.style.display = 'none';
                        const novoNomeElement = document.getElementById('novoNome');
                        if (novoNomeElement) novoNomeElement.value = '';
                    }
                });
            }

            function toggleCamposReligioso() {
                if (casamentoReligiosoRadio && casamentoReligiosoRadio.checked) {
                    if (camposReligioso) camposReligioso.style.display = 'block';
                } else {
                    if (camposReligioso) camposReligioso.style.display = 'none';
                    if (localCelebracaoInput) localCelebracaoInput.value = '';
                    if (autoridadeReligiosaInput) autoridadeReligiosaInput.value = '';
                }
            }

            if (casamentoCivilRadio) casamentoCivilRadio.addEventListener('change', toggleCamposReligioso);
            if (casamentoReligiosoRadio) casamentoReligiosoRadio.addEventListener('change', toggleCamposReligioso);
            toggleCamposReligioso(); // Initial call

            // Handle form submission (Save to Firestore and Generate PDF)
            if (marriageForm) {
                marriageForm.addEventListener('submit', async (event) => {
                    event.preventDefault(); // Prevent default form submission

                    const formData = new FormData(marriageForm);
                    const data = {};
                    for (let [key, value] of formData.entries()) {
                        data[key] = value;
                    }

                    data['tipoCasamento'] = document.querySelector('input[name="tipoCasamento"]:checked')?.value;

                    let requiredFields = [
                        'noivo1Nome', 'noivo1CPF', 'noivo1DataNascimento', 'noivo1Nacionalidade', 'noivo1Naturalidade', 'noivo1EstadoCivil', 'noivo1Profissao', 'noivo1NomeMae', 'noivo1Endereco',
                        'noivo2Nome', 'noivo2CPF', 'noivo2DataNascimento', 'noivo2Nacionalidade', 'noivo2Naturalidade', 'noivo2EstadoCivil', 'noivo2Profissao', 'noivo2NomeMae', 'noivo2Endereco',
                        'regimeBens', 'alteracaoNome', 'dataCasamento', 'horarioCasamento',
                        'testemunha1Nome', 'testemunha1CPF', 'testemunha2Nome', 'testemunha2CPF'
                    ];

                    let allFieldsFilled = true;

                    if (data.tipoCasamento === 'Religioso com Efeito Civil') {
                        requiredFields.push('localCelebracao', 'autoridadeReligiosa');
                    }

                    for (const field of requiredFields) {
                        const element = document.getElementById(field);
                        if (element && (!data[field] || data[field].trim() === '')) {
                            allFieldsFilled = false;
                            element.style.borderColor = 'red';
                        } else if (element) {
                            element.style.borderColor = '#D8D8D8';
                        }
                    }

                    if (data.alteracaoNome === 'Sim' && (!data.novoNome || data.novoNome.trim() === '')) {
                        allFieldsFilled = false;
                        const novoNomeElement = document.getElementById('novoNome');
                        if (novoNomeElement) novoNomeElement.style.borderColor = 'red';
                    } else if (data.alteracaoNome === 'Não') {
                         const novoNomeElement = document.getElementById('novoNome');
                         if (novoNomeElement) novoNomeElement.style.borderColor = '#D8D8D8';
                    }


                    if (!allFieldsFilled) {
                        showMessageBox('Atenção!', 'Por favor, preencha todos os campos obrigatórios antes de salvar e gerar o PDF.');
                        return;
                    }

                    if (!userId) {
                        showMessageBox('Erro de Autenticação', 'Não foi possível salvar os dados. Por favor, recarregue a página e tente novamente.');
                        return;
                    }

                    // Generate protocol number before saving
                    data.protocolNumber = generateProtocolNumber();

                    try {
                        // Save data to Firestore
                        const docRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/marriageRegistrations`), data);
                        console.log("Document written with ID: ", docRef.id);
                        showMessageBox('Sucesso!', `Pré-cadastro salvo com sucesso! Protocolo: ${data.protocolNumber}`);

                        // Generate PDF with the saved data (including protocol number)
                        generatePdf(data);

                        // Optionally clear the form after successful submission
                        marriageForm.reset();
                        toggleCamposReligioso(); // Reset religious fields visibility
                        if (campoNovoNome) campoNovoNome.style.display = 'none'; // Hide new name field
                    } catch (e) {
                        console.error("Error adding document: ", e);
                        showMessageBox('Erro', 'Ocorreu um erro ao salvar o pré-cadastro. Tente novamente.');
                    }
                });
            }
        });
    </script>
</body>
</html>
